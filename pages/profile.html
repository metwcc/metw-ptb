<div class="profile full-x">
    <div>
        <img />
        <div id="upload-pp" onclick="uploadPp()"> <button classs="center-x">değiştir</button> </div>
    </div>
    <div>
        <h1 class="icon">@<span></span></h1>
        <input oninput="customInput(event, 255, /[^\s\S]/g)" />
        <p></p>
    </div>
    <div>
        <button class="icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M7.43,7.68A3.84,3.84,0,1,0,3.59,3.84,3.84,3.84,0,0,0,7.43,7.68ZM18.85,6.41H13.77a1.15,1.15,0,1,0,0,2.29h5.08a1.15,1.15,0,1,0,0-2.29ZM7.43,9.83A7.43,7.43,0,0,0,0,17.26H14.86A7.42,7.42,0,0,0,7.43,9.83Z" /></svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path class="cls-1" d="M7.43,7.68A3.84,3.84,0,1,0,3.59,3.84,3.84,3.84,0,0,0,7.43,7.68ZM18.85,6.41H17.46V5a1.15,1.15,0,0,0-2.3,0V6.41H13.77a1.15,1.15,0,1,0,0,2.29h1.39v1.37a1.15,1.15,0,0,0,2.3,0V8.7h1.39a1.15,1.15,0,1,0,0-2.29ZM7.43,9.83A7.43,7.43,0,0,0,0,17.26H14.86A7.42,7.42,0,0,0,7.43,9.83Z" /></svg>
            <span>takip et</span>
        </button>
        <br /><a><span></span> takip</a>
        <br /><a><span></span> takipçi</a>
    </div>
</div>
<div class="follow-list">
    <b>✕</b>
    <a></a>
    <ul>
    </ul>
    <a>devamını yükle</a><br />
</div>
<div class="full-size top" id="image-crop" style="display: none">
    <div class="center">
        <img class="center" />
        <span class="center"></span><span class="center"></span>
        <input class="center-x" type="range">
        <div class="center-x">
            <button onclick="uploadPp(true)">onayla</button>
            <button onclick="redirect(pathname[0])">iptal</button>
        </div>
    </div>
</div>
<div class="user-content">
    <ul>

    </ul>
    <b>+</b>
</div>
<style>
    .profile { background-color: var(--background-color-1st); padding: 10px; height: 150px; transform: translate(-30px, -30px); width: calc(100% + 60px); box-shadow: 0px 1px 1px var(--background-color-top-1st) inset }
    .profile > div { display: inline-block; position: absolute }
    .profile > div:first-of-type { padding: 15px 20px; height: 120px }
    .profile > div:first-of-type > * { display: inline-block; height: 100px; position: absolute; border-radius: 10px }
    .profile > div:nth-of-type(2) { margin-left: 150px; width: calc(100% - 190px) }
    .profile > div:nth-of-type(2) > h1 { margin: 0 }
    .profile > div:nth-of-type(2) > h1 > img { height: 1em; top: .2em; left: -.02em }
    .profile > div:nth-of-type(2) > h1 > img:first-of-type { left: .2em }
    .profile > div:nth-of-type(2) > input { border: 3px dotted var(--background-color-2nd); width: 50%; display: none }
    .profile > div:nth-of-type(2) > p { width: calc(100% - 130px); text-wrap: normal; margin: 0; max-height: 80px; overflow-y: auto }
    .profile > div:last-of-type { font-size: 100%; right: 10px; top: 50%; transform: translateY(-50%); display: none }
    .profile > div:last-of-type > a { cursor: pointer }
    .profile > div:last-of-type > button { background-color: #1EB955; display: none }
    .profile > div:last-of-type > svg { display: none }

    .follow-list { background: var(--background-color-1st); height: calc(100% - 270px); width: calc(100% - 60px); border-radius: 10px; display: none; overflow: hidden auto; z-index: 2; position: absolute }
    .follow-list > a:first-of-type { padding: 20px 20px 10px 20px; display: inline-block; font-size: 22px; float: left; width: calc(100% - 70px) }
    .follow-list > ul { margin: 0; padding: 10px 10px }
    .follow-list > ul > li { display: inline-block; list-style-type: none; margin: 10px; height: 60px; background-color: var(--background-color-2nd); border-radius: 10px; padding: 10px; width: calc(50% - 20px); overflow: hidden; white-space: nowrap; cursor: pointer; user-select: none }
    .follow-list > ul > li > * { display: inline-block; float: left }
    .follow-list > ul > li > img { height: 40px; border-radius: 5px }
    .follow-list > ul > li > span { line-height: 40px; font-size: 30px; margin-left: 10px; width: calc(100% - 100px) }
    .follow-list > a:last-of-type { margin: 0 20px; color: var(--link-color); text-decoration: underline; display: none }
    .follow-list > b { display: inline-block; float: right; background-color: red; margin: 20px 20px 0 0; width: 30px; height: 30px; text-align: center; line-height: 30px; border-radius: 5px; cursor: pointer; user-select: none }

    .user-content > b { position: absolute; bottom: 30px; right: 30px; width: 30px; height: 30px; background-color: var(--background-color-3rd); border-radius: 50%; text-align: center; line-height: 30px; font-size: 20px; cursor: pointer; user-select: none }


    #upload-pp { width: 100px; height: 100px; display: inline-block; position: absolute; opacity: 0; transition: 0.1s }
    #upload-pp:hover { opacity: 1 }
    #upload-pp:hover::after { opacity: 0 }
    #upload-pp > button { margin-top: 5px; left: 50%; transform: translateX(-50%); position: absolute; background-color: var(--background-color-2nd) }
    #image-crop { left: 0; user-select: none; -webkit-user-drag: none }
    #image-crop > div { width: 80%; height: 80%; background-color: var(--background-color-top-1st); border-radius: 15px; padding: 15px; overflow: hidden; border: 10px solid var(--background-color-top-1st); outline: 10px solid rgba(0 0 0 / 0.5); outline-offset: -10px }
    #image-crop > div > * { -webkit-user-drag: none }
    #image-crop > div > img { border-radius: 10px }
    #image-crop > div > input { bottom: 20px; -webkit-appearance: none; background-color: var(--background-color-top-2nd); height: 20px; border-radius: 10px; outline: 2px solid var(--color); padding: 0 }
    #image-crop > div > input::-webkit-slider-thumb { -webkit-appearance: none; width: 20px; height: 20px; margin: 0px; border-radius: 50%; background: var(--color); cursor: pointer; outline: 10px solid var(--color); outline-offset: -5px }
    #image-crop > div > span:first-of-type { border: 3px dashed var(--color); border-radius: 10px; outline: calc(100vw) solid rgba(0 0 0 / 0.5) }
    #image-crop > div > span:last-of-type { border: 2px solid var(--color); border-radius: 50% }
    #image-crop > div > div > button { background-color: var(--background-color-top-2nd); border: 5px solid var(--background-color-top-1st); font-size: 120%; z-index: 2 }

    @media (max-width: 800px) {
        .profile { height: 180px }
        .profile > div:nth-of-type(2) > p { width: calc(100% - 10px) }
        .profile > div:last-of-type > br { display: none }
        .profile > div:last-of-type { left: 30px; top: unset; bottom: 5px; transform: translateY(calc(10% - 10px)) }
        
        .follow-list { height: calc(100% - 330px) }
        .follow-list > ul > li { width: calc(100% - 10px) }
    }
</style>
<script>
    var pd = {
        user: { name: pathname[0].substring(1) },
        profile: Object.assign(by.selector('.profile > div:nth-of-type(2)'),
            {
                photo: by.selector('.profile > div:first-of-type > img'), photoChange: by.id('upload-pp'),
                username: by.selector('.profile > div:nth-of-type(2) > h1'), usernameInner: by.selector('.profile > div:nth-of-type(2) > h1 > span'),
                bioInput: by.selector('.profile > div:nth-of-type(2) > input'), bio: by.selector('.profile > div:nth-of-type(2) > p'),
                followings: by.selector('.profile > div:last-of-type > a:first-of-type > span'), followers: by.selector('.profile > div:last-of-type > a:last-of-type > span'),
                follow: Object.assign(by.selector('.profile > div:last-of-type > button'), { text: by.selector('.profile > div:last-of-type > button > span'), unfollow: by.selector('.profile > div:last-of-type > button > svg:first-of-type'), follow: by.selector('.profile > div:last-of-type > button > svg:last-of-type') })
            }),
        followList: Object.assign(by.class('follow-list')[0],
            {
                followings: [],
                followers: [],
                page: 0
            })
    }; pd.user.isLoggedUsser = loggedUser && pd.user.name == loggedUser.username

    //#region LOAD PROFILE
    pd.profile.usernameInner.innerText = pd.user.name
    fetchJSON(backEndUrl + `users/${pd.user.name}` + (loggedUser ? `?id=${loggedUser.id}` : '')).then(([json, ok]) => {
        if (ok) {
            pd.profile.photo.src = avatarUrl(json.id, json.avatar)
            pd.profile.usernameInner.innerText = json.username + (getFlag(json.flags, 'mod') ? '*' : '')
            pd.profile.bio.innerText = pd.profile.bioInput.value = json.bio, pd.profile.bioInput.placeholder = 'bir şey yaz!'
            pd.profile.followings.innerText = json.followings, pd.profile.followers.innerText = json.followers
            pd.profile.follow.unfollow.style.display = ['none', 'inline-block'][+json.followed_by_you], pd.profile.follow.follow.style.display = ['inline-block', 'none'][+json.followed_by_you]
            by.selector('.profile > div:last-of-type > button > span').innerText = ['takip et', 'takipten çık'][+json.followed_by_you]
            pd.profile.follow.style.backgroundColor = ['#1EB955', 'red'][+json.followed_by_you]
            pd.profile.follow.style.display = ['inline-block', 'none'][+(pd.user.isLoggedUsser || !loggedUser.id)]
            pd.profile.data = json
            for (flag of flags.user) if (getFlag(json.flags, flag)) { var f = document.createElement('img'); f.src = `/images/svg/flags/${flag}.svg`; pd.profile.username.appendChild(f) }
            if (getFlag(json.flags, 'mod')) pd.profile.bio.innerHTML = json.bio
            pd.profile.style.paddingTop = (120 - pd.profile.clientHeight) / 2
            pd.profile.follow.parentElement.style.display = 'block'
            pd.profile.bio.style.display = ['block', 'none'][+pd.user.isLoggedUsser]
            pd.profile.photoChange.display = pd.profile.bioInput.style.display = ['none', 'block'][+pd.user.isLoggedUsser]
        }
        else redirect('404')
    })
    //#endregion


    //#region ACTIONS
    //follow
    pd.profile.follow.onclick = () => {
        fetchJSON(backEndUrl + `users/${pd.profile.data.id}/${pd.profile.data.followed_by_you ? 'un' : ''}follow`, { headers: { auth: token } }, true).then(([json, ok]) => {
            pd.profile.data.followers += (pd.profile.data.followed_by_you ? -1 : 1)
            pd.profile.followers.innerText = pd.profile.data.followers
            pd.profile.data.followed_by_you = !pd.profile.data.followed_by_you
            pd.profile.follow.unfollow.style.display = ['none', 'inline-block'][+pd.profile.data.followed_by_you], pd.profile.follow.follow.style.display = ['inline-block', 'none'][+pd.profile.data.followed_by_you]
            pd.profile.follow.text.innerText = ['takip et', 'takipten çık'][+pd.profile.data.followed_by_you]
            pd.profile.follow.style.backgroundColor = ['#1EB955', 'red'][+pd.profile.data.followed_by_you]
        })
    }

    //update bio
    pd.profile.bioInput.addEventListener('focusout', ({ target }) => { fetchJSON(backEndUrl + 'settings', { method: 'post', body: [{ action: 'update-bio', content: target.value.substring(0, 255) }], headers: { auth: token } }, true); return true })
    document.body.onresize = () => pd.profile.style.paddingTop = (120 - pd.profile.clientHeight) / 2

    //change pp
    if (pd.user.isLoggedUsser) {
        var uploadPp = async (state) => {
            if (state) {
                imageCrop.ratio2 = Math.max(imageCrop.img.sizeX, imageCrop.img.sizeY) / imageCrop.len / imageCrop.img.scale
                var p = [Math.abs(imageCrop.img.xPosition + imageCrop.frameSize / 2 - imageCrop.img.width / 2) * imageCrop.ratio2, Math.abs(imageCrop.img.yPosition + imageCrop.frameSize / 2 - imageCrop.img.height / 2) * imageCrop.ratio2,
                Math.abs(imageCrop.img.xPosition - imageCrop.frameSize / 2 - imageCrop.img.width / 2) * imageCrop.ratio2, Math.abs(imageCrop.img.yPosition - imageCrop.frameSize / 2 - imageCrop.img.height / 2) * imageCrop.ratio2]
                imageCrop.context.drawImage(imageCrop.img, p[0], p[1], p[2] - p[0], p[3] - p[1], 0, 0, 512, 512)
                imageCrop.data = imageCrop.canvas.toDataURL()
                imageCrop.context.clearRect(0, 0, imageCrop.canvas.width, imageCrop.canvas.height)
                imageCrop.input.style.display = by.selector('#image-crop > div > div').style.display = imageCrop.frames[1].style.display = imageCrop.frames[0].style.border = 'none'
                upload(imageCrop.data, '', 'usercontent-avatar').then(([json, ok]) => {
                    if (ok) { loggedUser.avatarUrl = cdnUrl + json; logged(true) }
                    else alert.error(json); redirect(pathname[0])
                })
            }
            else {
                imageCrop.canvas = document.createElement('canvas'), imageCrop.canvas.height = imageCrop.canvas.width = 512, imageCrop.context = imageCrop.canvas.getContext("2d")
                imageCrop.img.src = await filedialog('image/png,image/jpeg', true)
                imageCrop.style.display = 'flex'; imageCrop.img.xPosition = 0, imageCrop.img.yPosition = 0
                imageCrop.img.xPosition = imageCrop.img.yPosition = 0, imageCrop.img.scale = 1
                imageCrop.img.style.top = imageCrop.img.style.left = '50%'
            }
        }
        var imageCrop = by.id('image-crop'); imageCrop.click = false, imageCrop.touch = [0, 0], imageCrop.enableTouchMove = true
        imageCrop.frames = by.selectorAll('#image-crop > div > span'), imageCrop.div = by.selector('#image-crop > div'),
            imageCrop.img = by.selector('#image-crop > div > img'), imageCrop.input = by.selector('#image-crop > div > input')
        imageCrop.fixSizes = () => {
            for (let frame of imageCrop.frames) frame.style.width = frame.style.height = imageCrop.frameSize
            imageCrop.input.style.width = imageCrop.frameSize
            if (imageCrop.img.width < imageCrop.img.height) imageCrop.img.style.height = imageCrop.len * imageCrop.img.scale
            else imageCrop.img.style.width = imageCrop.len * imageCrop.img.scale
        }
        imageCrop.moveImage = (x, y) => {
            imageCrop.img.xPosition += x || 0, imageCrop.img.yPosition += y || 0
            if (imageCrop.img.xPosition > imageCrop.img.width / 2 - imageCrop.frameSize / 2) imageCrop.img.xPosition = imageCrop.img.width / 2 - imageCrop.frameSize / 2
            if (imageCrop.img.yPosition > imageCrop.img.height / 2 - imageCrop.frameSize / 2) imageCrop.img.yPosition = imageCrop.img.height / 2 - imageCrop.frameSize / 2
            if (imageCrop.img.xPosition < -imageCrop.img.width / 2 + imageCrop.frameSize / 2) imageCrop.img.xPosition = -imageCrop.img.width / 2 + imageCrop.frameSize / 2
            if (imageCrop.img.yPosition < -imageCrop.img.height / 2 + imageCrop.frameSize / 2) imageCrop.img.yPosition = -imageCrop.img.height / 2 + imageCrop.frameSize / 2
            imageCrop.img.style.left = `calc(50% + ${imageCrop.img.xPosition}px)`, imageCrop.img.style.top = `calc(50% + ${imageCrop.img.yPosition}px)`
        }
        imageCrop.img.onload = () => {
            imageCrop.ratio = (Math.min(imageCrop.img.width, imageCrop.img.height) / Math.max(imageCrop.img.width, imageCrop.img.height)), imageCrop.img.sizeX = imageCrop.img.width, imageCrop.img.sizeY = imageCrop.img.height
            imageCrop.frameSize = Math.min(imageCrop.div.clientWidth, imageCrop.div.clientHeight) / 2
            imageCrop.len = Math.min(imageCrop.div.clientWidth, imageCrop.div.clientHeight)
            imageCrop.img.scale = imageCrop.input.value = imageCrop.input.min = 50 / imageCrop.ratio, imageCrop.input.max = 200 / imageCrop.ratio, imageCrop.img.scale = imageCrop.img.scale / 100
            imageCrop.fixSizes()
        }
        window.onresize = imageCrop.fixSizes
        imageCrop.input.oninput = () => { imageCrop.img.scale = imageCrop.input.value / 100; imageCrop.fixSizes(); imageCrop.click = false; imageCrop.moveImage() }
        imageCrop.onmousedown = () => imageCrop.click = true; imageCrop.onmouseup = () => imageCrop.click = false
        imageCrop.onmousemove = event => { if (imageCrop.click) imageCrop.moveImage(event.movementX, event.movementY) }
        imageCrop.input.ontouchstart = () => { imageCrop.enableTouchMove = false }; imageCrop.input.ontouchend = () => imageCrop.enableTouchMove = true
        imageCrop.ontouchstart = ({ touches: [{ screenX, screenY }] }) => imageCrop.touch = [screenX, screenY]
        imageCrop.ontouchmove = ({ target, touches: [{ screenX, screenY }] }) => { if (imageCrop.enableTouchMove) imageCrop.moveImage(screenX - imageCrop.touch[0], screenY - imageCrop.touch[1]); imageCrop.touch = [screenX, screenY] }
    } else by.id('upload-pp').remove()

    //followings - followers page
    pd.followList.renderPage = async (t) => {
        var ids = (await fetchJSON(backEndUrl + `users/${pd.profile.data.id}/${t}?offset=${pd.followList.page * 10}`, true))[0].reverse()
        if (pd.followList[t].length < Math.min(pd.followList.page * 10 + 10, pd.profile.data[t])) pd.followList[t].push(...(await fetchJSON(backEndUrl + 'users/profiles?username&avatar&id', { method: 'post', body: ids }))[0])
        pd.followList.children[3].style.display = ['none', 'block'][+(pd.followList.page * 10 + 10 < pd.profile.data[t])]
        for (let user of pd.followList[t].slice(pd.followList.page * 10, pd.followList.page * 10 + 10).reverse()) {
            let userElem = document.createElement('li')
            userElem.onclick = () => redirect(`@${user.username}`, user.username)
            userElem.innerHTML = `<img src="${avatarUrl(user.id, user.avatar)}"><span>@${user.username}</span>`
            pd.followList.children[2].appendChild(userElem)
        }
    }
    pd.followList.f = async (t) => {
        if (!pd.profile.data) return
        pd.followList.children[1].innerText = `@${pd.profile.data.username}${(getFlag(pd.profile.data.flags, 'mod') ? '*' : '')} kullanıcısının ${t == 'followings' ? 'takipleri' : 'takipçileri'}`
        pd.followList.children[2].innerHTML = ''
        pd.followList.children[3].style.display = 'none'
        pd.followList.children[3].onclick = () => ((t) => { pd.followList.page++; pd.followList.renderPage(t) })(t)
        pd.followList.page = 0; pd.followList.renderPage(t)
        pd.followList.style.display = 'block'
    }
    pd.followList.children[0].onclick = () => pd.followList.style.display = 'none'

    pd.profile.followings.parentElement.onclick = () => pd.followList.f('followings')
    pd.profile.followers.parentElement.onclick = () => pd.followList.f('followers')
    //#endregion
</script>